<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배송 조회 - Thai Exotic Plants</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 2rem;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }
        .timeline-item:last-child:before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #10b981;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #10b981;
        }
        .timeline-dot.pending {
            background-color: #f59e0b;
            box-shadow: 0 0 0 2px #f59e0b;
        }
        .timeline-dot.inactive {
            background-color: #d1d5db;
            box-shadow: 0 0 0 2px #d1d5db;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-in-transit {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-out-for-delivery {
            background-color: #e0e7ff;
            color: #4338ca;
        }
        .status-delivered {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-green-600 to-teal-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-leaf text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Thai Exotic Plants</h1>
                        <p class="text-sm opacity-90">배송 추적 시스템</p>
                    </div>
                </div>
                <a href="/" class="bg-white text-green-600 px-4 py-2 rounded-lg hover:bg-green-50 transition">
                    <i class="fas fa-home mr-2"></i>홈으로
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Search Section -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-search mr-2 text-green-600"></i>
                    배송 추적
                </h2>
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="trackingInput"
                        placeholder="송장번호를 입력하세요"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    <button
                        onclick="trackShipment()"
                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"
                    >
                        <i class="fas fa-search mr-2"></i>조회
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    주문 확인 메일에서 송장번호를 확인하실 수 있습니다.
                </p>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden max-w-4xl mx-auto">
            <!-- Shipment Info -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">
                        <i class="fas fa-box mr-2 text-green-600"></i>
                        배송 정보
                    </h3>
                    <span id="statusBadge" class="status-badge"></span>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">송장번호</p>
                        <p class="font-semibold" id="trackingNumber">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">택배사</p>
                        <p class="font-semibold" id="carrierName">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">발송일</p>
                        <p class="font-semibold" id="shippedAt">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">예상 배송일</p>
                        <p class="font-semibold" id="estimatedDelivery">-</p>
                    </div>
                    <div class="md:col-span-2" id="deliveredAtContainer" style="display: none;">
                        <p class="text-sm text-gray-500">배송 완료일</p>
                        <p class="font-semibold text-green-600" id="deliveredAt">-</p>
                    </div>
                </div>

                <div class="mt-4" id="carrierLinkContainer">
                    <a id="carrierLink" href="#" target="_blank" class="text-green-600 hover:text-green-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i>
                        택배사 웹사이트에서 자세히 보기
                    </a>
                </div>

                <div class="mt-4" id="notesContainer" style="display: none;">
                    <p class="text-sm text-gray-500">배송 메모</p>
                    <p class="text-sm bg-gray-50 p-3 rounded" id="shippingNotes">-</p>
                </div>
            </div>

            <!-- Order Info -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-shopping-cart mr-2 text-green-600"></i>
                    주문 정보
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">주문번호</p>
                        <p class="font-semibold" id="orderId">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">주문금액</p>
                        <p class="font-semibold" id="orderAmount">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">받는 분</p>
                        <p class="font-semibold" id="customerName">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">주문 상태</p>
                        <p class="font-semibold" id="orderStatus">-</p>
                    </div>
                </div>
            </div>

            <!-- Tracking Timeline -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-6">
                    <i class="fas fa-route mr-2 text-green-600"></i>
                    배송 진행 현황
                </h3>
                <div id="timeline" class="space-y-4">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorSection" class="hidden max-w-2xl mx-auto">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                <p class="text-red-800 font-semibold mb-2">배송 정보를 찾을 수 없습니다</p>
                <p class="text-red-600 text-sm">송장번호를 다시 확인해 주세요.</p>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSection" class="hidden max-w-2xl mx-auto text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-3"></i>
            <p class="text-gray-600">배송 정보를 조회하는 중...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 Thai Exotic Plants. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'http://localhost:3000';

        // Track shipment on Enter key
        document.getElementById('trackingInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                trackShipment();
            }
        });

        // Check if tracking number is in URL
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tracking = urlParams.get('tracking');
            if (tracking) {
                document.getElementById('trackingInput').value = tracking;
                trackShipment();
            }
        });

        async function trackShipment() {
            const trackingNumber = document.getElementById('trackingInput').value.trim();

            if (!trackingNumber) {
                alert('송장번호를 입력해 주세요.');
                return;
            }

            // Hide previous results
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/shipments/track/${trackingNumber}`);
                const data = await response.json();

                document.getElementById('loadingSection').classList.add('hidden');

                if (data.success && data.shipment) {
                    displayShipment(data.shipment);
                } else {
                    document.getElementById('errorSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error tracking shipment:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
            }
        }

        function displayShipment(shipment) {
            document.getElementById('resultSection').classList.remove('hidden');

            // Shipment info
            document.getElementById('trackingNumber').textContent = shipment.tracking_number;
            document.getElementById('carrierName').textContent = shipment.carrier_name;
            document.getElementById('shippedAt').textContent = shipment.shipped_at
                ? formatDate(shipment.shipped_at)
                : '준비 중';
            document.getElementById('estimatedDelivery').textContent = shipment.estimated_delivery
                ? formatDate(shipment.estimated_delivery)
                : '확인 중';

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = getStatusText(shipment.shipping_status);
            statusBadge.className = `status-badge status-${shipment.shipping_status}`;

            // Delivered at (if delivered)
            if (shipment.delivered_at) {
                document.getElementById('deliveredAtContainer').style.display = 'block';
                document.getElementById('deliveredAt').textContent = formatDate(shipment.delivered_at);
            }

            // Carrier link
            if (shipment.carrier_tracking_url) {
                document.getElementById('carrierLink').href = shipment.carrier_tracking_url;
            }

            // Shipping notes
            if (shipment.shipping_notes) {
                document.getElementById('notesContainer').style.display = 'block';
                document.getElementById('shippingNotes').textContent = shipment.shipping_notes;
            }

            // Order info
            document.getElementById('orderId').textContent = `#${shipment.order_id}`;
            document.getElementById('orderAmount').textContent = formatCurrency(shipment.total_amount);
            document.getElementById('customerName').textContent = shipment.customer_name || '-';
            document.getElementById('orderStatus').textContent = getOrderStatusText(shipment.order_status);

            // Render timeline
            renderTimeline(shipment);
        }

        function renderTimeline(shipment) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            const statuses = [
                { key: 'pending', label: '배송 준비 중', icon: 'fa-box' },
                { key: 'in_transit', label: '배송 중', icon: 'fa-truck' },
                { key: 'out_for_delivery', label: '배송 출발', icon: 'fa-shipping-fast' },
                { key: 'delivered', label: '배송 완료', icon: 'fa-check-circle' }
            ];

            const currentStatusIndex = statuses.findIndex(s => s.key === shipment.shipping_status);

            statuses.forEach((status, index) => {
                const isActive = index <= currentStatusIndex;
                const isCurrent = index === currentStatusIndex;

                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';

                const dotClass = isActive ? (isCurrent ? 'pending' : '') : 'inactive';

                let timeText = '';
                if (status.key === 'pending' && shipment.shipped_at && isActive) {
                    timeText = `<span class="text-sm text-gray-500">${formatDateTime(shipment.shipped_at)}</span>`;
                } else if (status.key === 'delivered' && shipment.delivered_at && isActive) {
                    timeText = `<span class="text-sm text-gray-500">${formatDateTime(shipment.delivered_at)}</span>`;
                } else if (isActive) {
                    timeText = `<span class="text-sm text-gray-500">진행 중</span>`;
                }

                timelineItem.innerHTML = `
                    <div class="timeline-dot ${dotClass}"></div>
                    <div class="${isActive ? 'font-semibold' : 'text-gray-400'}">
                        <i class="fas ${status.icon} mr-2"></i>
                        ${status.label}
                        ${isCurrent ? '<span class="ml-2 text-green-600 text-sm">(현재 상태)</span>' : ''}
                    </div>
                    ${timeText}
                `;

                timeline.appendChild(timelineItem);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '배송 준비 중',
                'in_transit': '배송 중',
                'out_for_delivery': '배송 출발',
                'delivered': '배송 완료',
                'failed': '배송 실패'
            };
            return statusMap[status] || status;
        }

        function getOrderStatusText(status) {
            const statusMap = {
                'pending': '대기 중',
                'processing': '처리 중',
                'shipped': '발송 완료',
                'delivered': '배송 완료',
                'cancelled': '취소됨'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        }
    </script>
</body>
</html>
